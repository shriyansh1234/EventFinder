{% extends 'base.html' %}

{% block title %}Event Details - Event Finder{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ event.name }}</h1>
    <img src="{{ url_for('static', filename='images/' + event.image) }}" class="img-fluid" alt="{{ event.name }}" style="border-radius: 8px; width: 100%; height: auto;">

    <p><strong>Location:</strong> {{ event.location }}</p>
    <p><strong>Address:</strong> {{ event.address }}</p>
    <p><strong>Category:</strong> {{ event.category }}</p>
    <p><strong>Venue:</strong> {{ event.venue }}</p>
    <p><strong>Time:</strong> {{ event.time }}</p>
    <p><strong>Capacity:</strong> {{ event.capacity }}</p>

    <!-- Map Container -->
    <h5>Event Location on Map</h5>
    <div id="map" style="height: 400px;"></div> <!-- Set height for the map -->

    <h5>Seat Selection</h5>
    <label for="num_seats">Select number of seats:</label>
    <input type="number" id="num_seats" name="num_seats" min="1" max="{{ event.capacity }}" value="1" step="1" onchange="updateTotal()" onkeydown="return event.keyCode !== 46 && event.keyCode !== 110 && event.keyCode !== 190;">
    
    {% if event.paid %}
        <p><strong>Cost per seat:</strong> ${{ event.cost }}</p>
        
        <p><strong>Total Cost:</strong> $<span id="total_cost">{{ event.cost }}</span></p>
        <form action="{{ url_for('payment') }}" method="GET">
            <input type="hidden" id="hidden_total_cost" name="total_cost" value="{{ event.cost }}">
            <input type="hidden" id="hidden_num_seats" name="num_seats" value="1"> <!-- Default to 1 seat -->
            <button type="submit" class="btn btn-primary">Pay Now</button>
        </form>


    {% else %}
        <p><strong>This event is free!</strong></p>
        <button class="btn btn-success" onclick="alert('RSVP confirmed for {{ event.name }}!')">RSVP</button>
    {% endif %}
</div>

<script>
    function getLocation() {
        console.log("Page loaded, attempting to get location...");
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    function showPosition(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        initializeMap(lat, lon); // Initialize the map with the user's location
        geocodeAddress("265 Park Avenue West NW, Atlanta, GA 30313", (eventLat, eventLon) => {
    addEventMarker(eventLat, eventLon); // This should add a marker for the event address
});

    }

    function showError(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED:
                alert("User denied the request for Geolocation.");
                break;
            case error.POSITION_UNAVAILABLE:
                alert("Location information is unavailable.");
                break;
            case error.TIMEOUT:
                alert("The request to get user location timed out.");
                break;
            case error.UNKNOWN_ERROR:
                alert("An unknown error occurred.");
                break;
        }
    }
    let map;
    function initializeMap(lat, lon) {
    // Check if the map is already initialized
    if (!map) { // Only create the map if it doesn't exist
        map = L.map('map').setView([lat, lon], 13); // Set the initial view to the user's location
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);
        
        // Add a marker for the user's location
        L.marker([lat, lon]).addTo(map).bindPopup('You are here!').openPopup();
    } else {
        // If already initialized, just set the view to the new coordinates
        map.setView([lat, lon], 13);
    }
}

    function geocodeAddress(address, callback) {
        
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
        
        console.log("Geocoding address:", address);
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log("Geocode API response:", data); // Log the geocode response
                console.log("Geocode API full response:", JSON.stringify(data, null, 2)); // Log the full response for detailed inspection
            
                if (data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;
                    callback(lat, lon); // Pass coordinates to the callback function
                } else {
                    alert("Address not found.");
                }
            })
            .catch(error => {
                console.error("Error fetching the geocode:", error);
                alert("Failed to fetch location data.");
            });
    }

    function addEventMarker(lat, lon) {
        if(map)
        { // Get the existing map instance
            L.marker([lat, lon]).addTo(map).bindPopup('Event Location').openPopup(); // Add a marker for the event location        
        }
        else
        {
            console.error("Map is not initialized yet");
        }
    }

    function updateTotal() {
        const costPerSeat = parseFloat("{{ event.cost }}");
        const numSeats = parseFloat(document.getElementById('num_seats').value);
        const totalCost = (numSeats > 0) ? costPerSeat * numSeats : 0;
        document.getElementById('total_cost').innerText = totalCost.toFixed(2);
        document.getElementById('hidden_total_cost').value = totalCost.toFixed(2);
        document.getElementById('hidden_num_seats').value = numSeats;
    }
    
    // Get the user's location when the page loads
    window.onload = function() {
        getLocation();
    }
</script>
{% endblock %}
