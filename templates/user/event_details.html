{% extends 'base.html' %}

{% block title %}Event Details - Event Finder{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ event.name }}</h1>
    <img src="{{ url_for('static', filename='images/' + event.image_url) }}" class="img-fluid" alt="{{ event.name }}" style="border-radius: 8px; width: 100%; height: auto;">

    <p><strong>Location:</strong> {{ event.location }}</p>
    <p><strong>Category:</strong> {{ event.category_name }}</p>
    <p><strong>Date:</strong> {{ event.date }}</p>
    <p><strong>Start Time:</strong> {{ event.event_start }}</p>
    <p><strong>End Time:</strong> {{ event.event_end }}</p>
    <p><strong>Capacity:</strong> {{ event.capacity }}</p>

    <!-- Map Container -->
    <h5>Event Location and Route</h5>
    <div id="map" style="height: 400px;"></div> <!-- Set height for the map -->

    <h5>Seat Selection</h5>
    <label for="num_seats">Select number of seats:</label>
    <input type="number" id="num_seats" name="num_seats" min="1" max="{{ event.capacity }}" value="1" step="1" onchange="updateTotal()" onkeydown="return event.keyCode !== 46 && event.keyCode !== 110 && event.keyCode !== 190;">
    
    {% if event.paid %}
        <p><strong>Cost per seat:</strong> ${{ event.cost }}</p>
        <p><strong>Total Cost:</strong> $<span id="total_cost">{{ event.cost }}</span></p>
        <button class="btn btn-primary" onclick="alert('Mock payment process initiated for {{ event.event_name }}!')">Pay Now</button>
    {% else %}
        <p><strong>This event is free!</strong></p>
        <form method="POST" action="{{ url_for('event_details', event_id=event.event_id) }}">
            <button type="submit" class="btn btn-primary">RSVP</button>
        </form>
    {% endif %}
</div>

<!-- Leaflet and Routing Machine CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<script>
    let map; // Declare map globally to access across functions

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    function showPosition(position) {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;
        const eventAddress = "{{ event.location }}";

        initializeMap(userLat, userLon); // Initialize the map with the user's location

        // Geocode the event location (Replace with your own geocoding API if required)
        geocodeAddress(eventAddress, (eventLat, eventLon) => {
            addEventMarker(eventLat, eventLon); // Add marker for the event address
            calculateRoute(userLat, userLon, eventLat, eventLon); // Calculate and display route
        });
    }

    function initializeMap(lat, lon) {
        map = L.map('map').setView([lat, lon], 13);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap, © CartoDB',
            maxZoom: 19
        }).addTo(map);

        L.marker([lat, lon]).addTo(map).bindPopup('You are here!').openPopup();

        map.off('click');
    }

    function addEventMarker(eventLat, eventLon) {
        var eventIcon = L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
        });

        L.marker([eventLat, eventLon], { icon: eventIcon }).addTo(map).bindPopup('Event Location');
    }

    function calculateRoute(userLat, userLon, eventLat, eventLon) {
    L.Routing.control({
        waypoints: [
            L.latLng(userLat, userLon),
            L.latLng(eventLat, eventLon)
        ],
        routeWhileDragging: true,
        show: true,
        lineOptions: {
            styles: [
                {
                    color: 'red',
                    weight: 5,
                    opacity: 0.7
                }
            ]
        }
    }).addTo(map);
}

    function geocodeAddress(address, callback) {
        // Simple geocoding using Nominatim
        fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json`)
            .then(response => response.json())
            .then(data => {
                if (data && data[0]) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    callback(lat, lon);
                } else {
                    alert('Unable to geocode the event address.');
                }
            })
            .catch(error => console.error('Geocoding error:', error));
    }

    function showError(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED:
                alert("User denied the request for Geolocation.");
                break;
            case error.POSITION_UNAVAILABLE:
                alert("Location information is unavailable.");
                break;
            case error.TIMEOUT:
                alert("The request to get user location timed out.");
                break;
            case error.UNKNOWN_ERROR:
                alert("An unknown error occurred.");
                break;
        }
    }

    function updateTotal() {
        const costPerSeat = parseFloat("{{ event.cost }}" || 0); // Default cost if missing
        const numSeats = parseFloat(document.getElementById('num_seats').value);
        const totalCost = (numSeats > 0) ? costPerSeat * numSeats : 0;
        document.getElementById('total_cost').innerText = totalCost.toFixed(2);
    }
    
    // Get the user's location when the page loads
    window.onload = function() {
        getLocation();
    }
</script>
{% endblock %}
